---
import Layout from '../layouts/Layout.astro';
import Button from '../components/Button.astro';
import Card from '../components/Card.astro';
import { Icon } from 'astro-icon/components';
---

<Layout title="Parsha with Purpose - Chaya Adamson">
  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-floating-element hero-floating-element--top-right"></div>
    <div class="hero-floating-element hero-floating-element--bottom-left"></div>

    <div class="hero-content">
      <div style="max-width: 96rem; margin: 0 auto;">
        <div class="content-grid">
          <div>
            <h1 class="hero-title">Parsha with Purpose</h1>
            <p class="hero-subtitle">Relevant. Relatable. Real.</p>
            <div class="hero-divider"></div>
            <p
              style="font-size: 1.25rem; opacity: 0.9; font-weight: 300; line-height: 1.4; margin-bottom: 2rem;"
            >
              This isn't the parsha class you grew up with.
            </p>

            <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
              <Button
                variant="secondary"
                size="large"
                href="https://chat.whatsapp.com/DTm0JXsgkME9COv772vAaU"
                target="_blank"
              >
                <Icon name="mdi:whatsapp" />
                Join Live Class
              </Button>
              <Button
                href="https://podcasts.apple.com/us/podcast/parsha-with-purpose/id1799568860"
                target="_blank"
                variant="outline"
                size="large"
              >
                <Icon name="mdi:headphones" />
                Listen as Podcast
              </Button>
            </div>
          </div>

          <div style="display: flex; justify-content: center;">
            <div class="image-container image-container--floating">
              <div class="floating-effect"></div>
              <div
                class="image-wrapper podcast-image-wrapper"
                style="width: 24rem; height: 24rem; border-radius: 1.5rem; overflow: hidden; background-image: url('/images/thumbnail.webp'); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; position: relative;"
              >
                <!-- Dark overlay for better text readability -->
                <div
                  style="position: absolute; inset: 0; background: linear-gradient(180deg, rgba(43, 27, 12, 0.3), transparent, rgba(43, 27, 12, 0.6)); border-radius: 1.5rem;"
                >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- About the Class Section -->
  <section class="content-section content-section--light">
    <div class="section-floating-element section-floating-element--top-left">
    </div>

    <div class="section-content">
      <div class="section-header">
        <h2 class="section-title">A Living Torah Experience</h2>
        <div class="section-divider"></div>
      </div>

      <div style="max-width: 64rem; margin: 0 auto;">
        <div
          class="text-content"
          style="text-align: center; margin-bottom: 4rem;"
        >
          <p class="text-large">
            Each week, we learn the stories of the parsha that have once felt
            dry or irrelevant and uncover a living, breathing message. Something
            deeply personal, spiritual, and aligned with your real life.
          </p>
          <p class="text-large">
            We uncover the personal, emotional, and spiritual relevance hidden
            in the stories, and how it speaks directly to our lives,
            relationships, and inner worlds <em>right now</em>.
          </p>
          <p class="text-large">
            We go beyond the story to find the soul teachings. We connect to
            Torah as our guide, extracting the abundant wisdom it holds.
          </p>
          <p class="text-large">
            This class is for women who want to deepen their spiritual
            connection, ask real questions, and engage with Torah in a way
            that's alive, embodied, and relevant.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- This Class is For You Section -->
  <section class="content-section content-section--dark">
    <div
      class="section-floating-element section-floating-element--bottom-right"
    >
    </div>

    <div class="section-content">
      <div class="section-header">
        <h2 class="section-title">This Class is For You If</h2>
        <div class="section-divider section-divider--light"></div>
      </div>

      <div style="max-width: 48rem; margin: 0 auto;">
        <div class="grid" style="gap: 2rem;">
          <Card variant="glass">
            <div style="text-align: center; padding: 2rem;">
              <div
                style="width: 4rem; height: 4rem; background: rgba(248, 232, 212, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;"
              >
                <Icon name="mdi:heart" size={30} />
              </div>
              <p
                style="font-size: 1.25rem; color: rgba(255, 255, 255, 0.9); line-height: 1.4; margin: 0;"
              >
                You desire to learn Torah in a way that speaks to your soul.
              </p>
            </div>
          </Card>

          <Card variant="glass">
            <div style="text-align: center; padding: 2rem;">
              <div
                style="width: 4rem; height: 4rem; background: rgba(248, 232, 212, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;"
              >
                <Icon name="mdi:flower-lotus" size={30} />
              </div>
              <p
                style="font-size: 1.25rem; color: rgba(255, 255, 255, 0.9); line-height: 1.4; margin: 0;"
              >
                You crave a feminine, grounded approach to learning that honors
                your own path and inner knowing.
              </p>
            </div>
          </Card>

          <Card variant="glass">
            <div style="text-align: center; padding: 2rem;">
              <div
                style="width: 4rem; height: 4rem; background: rgba(248, 232, 212, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;"
              >
                <Icon name="mdi:venn-diagram" size={30} />
              </div>
              <p
                style="font-size: 1.25rem; color: rgba(255, 255, 255, 0.9); line-height: 1.4; margin: 0;"
              >
                You're integrating spirituality with personal healing and
                self-leadership.
              </p>
            </div>
          </Card>

          <Card variant="glass">
            <div style="text-align: center; padding: 2rem;">
              <div
                style="width: 4rem; height: 4rem; background: rgba(248, 232, 212, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;"
              >
                <Icon name="mdi:account-clock" size={30} />
              </div>
              <p
                style="font-size: 1.25rem; color: rgba(255, 255, 255, 0.9); line-height: 1.4; margin: 0;"
              >
                You're a busy woman who want to learn, short accessible, work,
                carpool, live or podcast
              </p>
            </div>
          </Card>
        </div>
      </div>
    </div>
  </section>

  <!-- Testimonials Section -->
  <section class="content-section content-section--light testimonials-section">
    <div class="section-floating-element section-floating-element--center">
    </div>
    <div class="section-content">
      <div class="section-header">
        <h2 class="section-title">What Women Are Saying</h2>
        <div class="section-divider"></div>
      </div>

      <div class="testimonials-container">
        <div class="testimonials-carousel" id="testimonials-carousel">
          <!-- Testimonial 1 - Learn -->
          <div class="testimonial-slide active">
            <div class="testimonial-content">
              <h3
                style="font-size: 1.5rem; font-weight: 500; color: #2b1b0c; margin-bottom: 1rem; text-align: center;"
              >
                Learn
              </h3>
              <p class="testimonial-text">
                It's the highlight of my week! I know I could show up to learn,
                and there is something special waiting for me. The lessons are
                spiritual, mystical and practical all at the same time. I had no
                idea that topics that felt so foreign in the past could feel so
                relevant to me. This is the first time I've felt like Torah is
                *mine*. Like it's speaking to me, not at me.
              </p>
              <p
                style="text-align: right; font-style: italic; color: rgba(43, 27, 12, 0.7); margin-top: 1rem;"
              >
                - Rivka
              </p>
            </div>
          </div>

          <!-- Testimonial 2 - Connect -->
          <div class="testimonial-slide">
            <div class="testimonial-content">
              <h3
                style="font-size: 1.5rem; font-weight: 500; color: #2b1b0c; margin-bottom: 1rem; text-align: center;"
              >
                Connect
              </h3>
              <p class="testimonial-text">
                This class is a time and space that I get to come to weekly to
                connect to torah, to myself, and to others who are on the same
                path as me. It has awakened in me the desire to learn and
                connect through torah for the first time in my life. I never
                thought that was possible.
              </p>
              <p
                style="text-align: right; font-style: italic; color: rgba(43, 27, 12, 0.7); margin-top: 1rem;"
              >
                - Esther
              </p>
            </div>
          </div>

          <!-- Testimonial 3 - Grow -->
          <div class="testimonial-slide">
            <div class="testimonial-content">
              <h3
                style="font-size: 1.5rem; font-weight: 500; color: #2b1b0c; margin-bottom: 1rem; text-align: center;"
              >
                Grow
              </h3>
              <p class="testimonial-text">
                Thank you for making that story relatable to me. In the way that
                we learn, I feel connected and alive with the Torah. I look back
                on the teachings from my past, and feel deeply how different
                this is. It opens me up in a whole new way. Somehow each week
                the class speaks directly to me, in a way that speaks straight
                to my soul with a lesson that is relevant to my current
                struggle. It's almost as if the torah is communicating with me.
              </p>
              <p
                style="text-align: right; font-style: italic; color: rgba(43, 27, 12, 0.7); margin-top: 1rem;"
              >
                - Rus
              </p>
            </div>
          </div>
        </div>

        <!-- Navigation Arrows -->
        <button
          class="testimonial-nav testimonial-nav--prev"
          id="prev-testimonial"
          aria-label="Previous testimonial"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M15 18L9 12L15 6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"></path>
          </svg>
        </button>

        <button
          class="testimonial-nav testimonial-nav--next"
          id="next-testimonial"
          aria-label="Next testimonial"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M9 18L15 12L9 6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"></path>
          </svg>
        </button>

        <!-- Dots Navigation -->
        <div class="testimonials-dots" id="testimonials-dots">
          <button
            class="testimonial-dot active"
            data-slide="0"
            aria-label="Go to testimonial 1"></button>
          <button
            class="testimonial-dot"
            data-slide="1"
            aria-label="Go to testimonial 2"></button>
          <button
            class="testimonial-dot"
            data-slide="2"
            aria-label="Go to testimonial 3"></button>
        </div>
      </div>
    </div>
  </section>

  <!-- Latest Episode Section -->
  <section class="content-section content-section--dark">
    <div
      class="section-floating-element section-floating-element--bottom-right"
    >
    </div>

    <div class="section-content">
      <div class="section-header">
        <h2 class="section-title">Latest Episode</h2>
        <div class="section-divider section-divider--light"></div>
      </div>

      <div style="max-width: 64rem; margin: 0 auto;">
        <Card variant="glass">
          <div class="content-grid" style="align-items: start;">
            <div style="grid-column: span 2;">
              <div class="episode-meta episode-meta--light">
                <Icon name="mdi:calendar" />
                <span class="meta-text" id="latest-episode-date"></span>
                <Icon name="mdi:clock-time-four-outline" />
                <span class="meta-text" id="latest-episode-duration">32:15</span
                >
              </div>

              <h3
                style="font-size: 2.5rem; font-weight: 400; letter-spacing: 0.05em; margin-bottom: 1.5rem; color: rgba(255, 255, 255, 0.95); line-height: 1.2;"
                id="latest-episode-title"
              >
              </h3>

              <p
                style="font-size: 1.25rem; opacity: 0.85; line-height: 1.4; font-weight: 300; margin-bottom: 2rem; color: rgba(255, 255, 255, 0.85);"
                id="latest-episode-description"
              >
              </p>

              <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                <Button
                  href="https://podcasts.apple.com/us/podcast/parsha-with-purpose/id1799568860"
                  variant="secondary"
                  size="large"
                  id="play-latest-episode"
                  target="_blank"
                >
                  <svg class="btn-icon" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"></path>
                  </svg>
                  Play Episode
                </Button>
              </div>
            </div>
          </div>
        </Card>
      </div>
    </div>
  </section>

  <!-- Class Details Section -->
  <section class="content-section content-section--light">
    <div class="section-floating-element section-floating-element--top-left">
    </div>

    <div class="section-content">
      <div class="section-header">
        <h2 class="section-title">Class Details</h2>
        <div class="section-divider"></div>
      </div>

      <div style="max-width: 48rem; margin: 0 auto;">
        <div
          class="grid grid--three-cols"
          style="gap: 3rem; margin-bottom: 3rem;"
        >
          <Card>
            <div style="text-align: center;">
              <div
                style="width: 4rem; height: 4rem; background: rgba(43, 27, 12, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;"
              >
                <Icon name="mdi:video" size={30} />
              </div>
              <h3
                style="font-size: 1.25rem; font-weight: 500; color: #2b1b0c; margin-bottom: 0.5rem;"
              >
                Live Class
              </h3>
              <p style="color: rgba(43, 27, 12, 0.7); margin: 0;">via Zoom</p>
            </div>
          </Card>

          <Card>
            <div style="text-align: center;">
              <div
                style="width: 4rem; height: 4rem; background: rgba(43, 27, 12, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;"
              >
                <Icon name="mdi:calendar-multiple" size={30} />
              </div>
              <h3
                style="font-size: 1.25rem; font-weight: 500; color: #2b1b0c; margin-bottom: 0.5rem;"
              >
                Weekly
              </h3>
              <p style="color: rgba(43, 27, 12, 0.7); margin: 0;">
                Thursdays 9:00 AM
              </p>
            </div>
          </Card>

          <Card>
            <div style="text-align: center;">
              <div
                style="width: 4rem; height: 4rem; background: rgba(43, 27, 12, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;"
              >
                <Icon name="mdi:podcast" size={30} />
              </div>
              <h3
                style="font-size: 1.25rem; font-weight: 500; color: #2b1b0c; margin-bottom: 0.5rem;"
              >
                Available
              </h3>
              <p style="color: rgba(43, 27, 12, 0.7); margin: 0;">
                on Spotify and Apple Podcasts
              </p>
            </div>
          </Card>
        </div>
      </div>
    </div>
  </section>

  <!-- Join Section -->
  <section class="content-section content-section--light">
    <div class="section-floating-element section-floating-element--center">
    </div>

    <div class="container" style="text-align: center;">
      <div style="max-width: 64rem; margin: 0 auto;">
        <div style="margin-bottom: 3rem;">
          <h2 class="section-title">Join the Journey</h2>
          <p
            style="font-size: 1.5rem; opacity: 0.8; font-weight: 300; line-height: 1.4;"
          >
            Experience Torah like never before.
          </p>
        </div>

        <div
          style="display: flex; flex-wrap: wrap; justify-content: center; gap: 1.5rem; margin-bottom: 2rem;"
        >
          <Button
            variant="primary"
            size="large"
            href="https://chat.whatsapp.com/DTm0JXsgkME9COv772vAaU"
            target='_blank'
          >
            <Icon name="mdi:whatsapp" />
            Join Live Class
          </Button>
        </div>

        <div style="margin-top: 2rem;">
          <p style="font-size: 1.125rem; opacity: 0.7; margin-bottom: 1rem;">
            Listen here:
          </p>
          <div
            style="display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem;"
          >
            <Button
              class="btn-podcast"
              variant="outline"
              size="medium"
              href="https://podcasts.apple.com/us/podcast/parsha-with-purpose/id1799568860"
              target="_blank"
            >
              <Icon name="mdi:apple" />
              Apple Podcasts
            </Button>
            <Button
              class="btn-podcast"
              variant="outline"
              size="medium"
              href="https://open.spotify.com/show/6TNloSZWahwAKN17eKrcKW?si=b753383a964e4164"
              target="_blank"
            >
              <Icon name="mdi:spotify" />
              Spotify
            </Button>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  // RSS Feed Integration for Latest Episode
  async function loadLatestEpisode() {
    try {
      const RSS_URL = 'https://anchor.fm/s/101e42184/podcast/rss';
      console.log('Fetching latest episode from RSS feed...');

      const response = await fetch(RSS_URL);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      // Format duration to show as "30 min" instead of "00:29:56"
      function formatDuration(duration) {
        if (!duration || duration === 'Unknown') return 'Unknown';

        // Handle HH:MM:SS format (like 00:29:56)
        if (duration.includes(':')) {
          const parts = duration.split(':');
          if (parts.length === 3) {
            // HH:MM:SS format
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            const seconds = parseInt(parts[2], 10);

            // Round to nearest minute
            let totalMinutes = hours * 60 + minutes;
            if (seconds >= 30) totalMinutes += 1; // Round up if 30+ seconds

            if (totalMinutes >= 60) {
              const hrs = Math.floor(totalMinutes / 60);
              const mins = totalMinutes % 60;
              return mins > 0 ? `${hrs}h ${mins}min` : `${hrs}h`;
            } else {
              return `${totalMinutes} min`;
            }
          } else if (parts.length === 2) {
            // MM:SS format
            const minutes = parseInt(parts[0], 10);
            const seconds = parseInt(parts[1], 10);

            let totalMinutes = minutes;
            if (seconds >= 30) totalMinutes += 1; // Round up if 30+ seconds

            return `${totalMinutes} min`;
          }
        }

        // Handle seconds-only format (like "1796")
        if (!isNaN(duration)) {
          const totalSeconds = parseInt(duration, 10);
          const minutes = Math.round(totalSeconds / 60);

          if (minutes >= 60) {
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return remainingMinutes > 0
              ? `${hours}h ${remainingMinutes}min`
              : `${hours}h`;
          } else {
            return `${minutes} min`;
          }
        }

        // Return as-is if we can't parse it
        return duration;
      }

      const rssText = await response.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(rssText, 'application/xml');

      const channel = xmlDoc.querySelector('channel');
      if (!channel) {
        throw new Error('No channel found in RSS feed');
      }

      // Get the first (latest) episode
      const latestItem = channel.querySelector('item');
      if (!latestItem) {
        throw new Error('No episodes found in RSS feed');
      }

      // Extract episode data
      const title =
        latestItem.querySelector('title')?.textContent || 'Latest Episode';
      const description =
        latestItem.querySelector('description')?.textContent || '';
      const pubDateRaw = latestItem.querySelector('pubDate')?.textContent;

      // Try multiple ways to get duration - RSS feeds can use different namespace formats
      let durationRaw = 'Unknown';

      // Try different selectors for duration
      const durationSelectors = [
        'itunes\\:duration',
        'duration',
        '[*|duration]',
      ];

      for (const selector of durationSelectors) {
        try {
          const durationElement = latestItem.querySelector(selector);
          if (
            durationElement &&
            durationElement.textContent &&
            durationElement.textContent.trim()
          ) {
            durationRaw = durationElement.textContent.trim();
            break;
          }
        } catch (e) {
          // Continue to next selector
        }
      }

      // If still no duration found, try getElementsByTagName approach
      if (durationRaw === 'Unknown') {
        try {
          const itunesDuration =
            latestItem.getElementsByTagName('itunes:duration')[0];
          if (itunesDuration && itunesDuration.textContent) {
            durationRaw = itunesDuration.textContent.trim();
          }
        } catch (e) {
          // Try without namespace
          try {
            const simpleDuration =
              latestItem.getElementsByTagName('duration')[0];
            if (simpleDuration && simpleDuration.textContent) {
              durationRaw = simpleDuration.textContent.trim();
            }
          } catch (e2) {
            console.warn('Could not parse duration from RSS feed');
          }
        }
      }

      // Clean and format the data
      const cleanTitle = title.trim();
      let cleanDescription = description
        .replace(/<[^>]*>/g, '') // Remove HTML tags
        .replace(/&[^;]+;/g, ' ') // Remove HTML entities
        .replace(/\s+/g, ' ') // Normalize whitespace
        .trim();

      if (cleanDescription.length > 300) {
        cleanDescription = cleanDescription.substring(0, 300) + '...';
      }

      // Format date
      let formattedDate = 'Recent';
      if (pubDateRaw) {
        try {
          const date = new Date(pubDateRaw);
          formattedDate = date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
          });
        } catch (e) {
          console.warn('Could not parse date:', pubDateRaw);
        }
      }

      // Update the DOM elements
      const titleElement = document.getElementById('latest-episode-title');
      const descriptionElement = document.getElementById(
        'latest-episode-description'
      );
      const dateElement = document.getElementById('latest-episode-date');
      const durationElement = document.getElementById(
        'latest-episode-duration'
      );

      if (titleElement) titleElement.textContent = cleanTitle;
      if (descriptionElement) descriptionElement.textContent = cleanDescription;
      if (dateElement) dateElement.textContent = formattedDate;
      if (durationElement)
        durationElement.textContent = formatDuration(durationRaw);

      // Get audio URL for play button
      const enclosure = latestItem.querySelector('enclosure');
      const audioUrl = enclosure?.getAttribute('url');

      if (audioUrl) {
        const playButton = document.getElementById('play-latest-episode');
        if (playButton) {
          playButton.addEventListener('click', () => {
            // Open audio in new tab or trigger download
            window.open(audioUrl, '_blank');
          });
        }
      }

      console.log('Latest episode loaded successfully:', cleanTitle);
    } catch (error) {
      console.warn(
        'Could not load latest episode from RSS feed:',
        error.message
      );
      // Fallback content is already in the HTML, so we don't need to do anything
    }
  }

  // Load latest episode when page loads
  document.addEventListener('DOMContentLoaded', function () {
    // Load testimonials carousel (existing code)
    const carousel = document.getElementById('testimonials-carousel');
    if (carousel) {
      const slides = carousel.querySelectorAll('.testimonial-slide');
      const dots = document.querySelectorAll('.testimonial-dot');
      const prevBtn = document.getElementById('prev-testimonial');
      const nextBtn = document.getElementById('next-testimonial');

      let currentSlide = 0;
      const totalSlides = slides.length;
      let autoRotate;

      function showSlide(index) {
        slides.forEach((slide) => slide.classList.remove('active'));
        dots.forEach((dot) => dot.classList.remove('active'));

        if (slides[index]) slides[index].classList.add('active');
        if (dots[index]) dots[index].classList.add('active');

        currentSlide = index;
      }

      function nextSlide() {
        const next = (currentSlide + 1) % totalSlides;
        showSlide(next);
      }

      function prevSlide() {
        const prev = (currentSlide - 1 + totalSlides) % totalSlides;
        showSlide(prev);
      }

      function startAutoRotate() {
        autoRotate = setInterval(nextSlide, 6000);
      }

      function stopAutoRotate() {
        if (autoRotate) {
          clearInterval(autoRotate);
        }
      }

      if (nextBtn) nextBtn.addEventListener('click', nextSlide);
      if (prevBtn) prevBtn.addEventListener('click', prevSlide);

      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => showSlide(index));
      });

      startAutoRotate();

      carousel.addEventListener('mouseenter', stopAutoRotate);
      carousel.addEventListener('mouseleave', startAutoRotate);
      carousel.addEventListener('focusin', stopAutoRotate);
      carousel.addEventListener('focusout', startAutoRotate);
    }

    // Load latest episode from RSS feed
    loadLatestEpisode();
  });
</script>
